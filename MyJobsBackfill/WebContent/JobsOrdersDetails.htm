<!DOCTYPE html>
<html>
<head>

  <title>Jobs - Order Details
  </title>
<script src="js/html5sql.js"></script>  
<script src="js/MyJobsDB.js"></script>
<script src="js/MyJobsUtils.js"></script>

  <script type='text/javascript' src='js/jquery-1.11.1.min.js'></script>
  <script type='text/javascript' src='js/jquery.mobile-1.4.2.min.js'></script>

  <link rel="stylesheet" href="css/jqm-inlinetabs.min.css" />
  <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.2.min.css">

<script src="js/jquery.mobile.datepicker.js"></script>
<script src="js/jquery-ui/datepicker.js"></script>


<script type='text/javascript' src="tablesorter/js/jquery.tablesorter.js"></script>
<script type='text/javascript' src="tablesorter/js/jquery.tablesorter.widgets.js"></script>

<script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/jqm-inlinetabs.js"></script>
  <link rel="stylesheet" type="text/css" href="tablesorter/css/theme.jui.css">
<link rel="stylesheet" type="text/css" href="tablesorter/css/theme.bootstrap.css">
<link rel="stylesheet" type="text/css" href="tablesorter/docs/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/jquery-ui.css">
<link rel="stylesheet" href="css/magnific-popup.css" />

<link rel="stylesheet" href="css/font-awesome.min.css">
	
  <style type='text/css'>
  
  .boxeddiv {border: 1px solid grey;
      margin: 1em 1em  1em 1em;
	
	border-radius: 10px;}

  .boxeddiv1 {border: 1px solid grey;
      
border-bottom-right-radius: 10px;
	border-bottom-left-radius: 10px;}
  
  .stripe{
	background-color: lightgrey; 
	color: black;
}
.checkboxtext
{
  /* Checkbox text */
  font-size: 110%;
  display: inline;
}
   .wrapper {
  position: relative;
  padding: 0 5px;
  height: 250px;
  overflow-y: auto;
}
 .mfp-fade.mfp-bg {
	opacity: 0.001; /* Chrome opacity transition bug */
	-webkit-transition: all 0.15s ease-out; 
	-moz-transition: all 0.15s ease-out; 
	transition: all 0.15s ease-out;
}
.mfp-fade.mfp-bg.mfp-ready {
	opacity: 0.8;
}
.mfp-fade.mfp-bg.mfp-removing {
	opacity: 0;
}

.mfp-fade.mfp-wrap .mfp-content {
	opacity: 0;
	-webkit-transition: all 0.15s ease-out; 
	-moz-transition: all 0.15s ease-out; 
	transition: all 0.15s ease-out;
}
.mfp-fade.mfp-wrap.mfp-ready .mfp-content {
	opacity: 1;
}
.mfp-fade.mfp-wrap.mfp-removing .mfp-content {
	opacity: 0;
}
  .block {
    border: 1px solid grey;
    width: 180px;
    height:150px;
    display: inline-block;
    margin: 1em 1em 1em 1em;

border-radius: 15px;
    left:50px
}
  .highlight {

     box-shadow: 5px 5px 5px #888888;

  }  
                .box {
    border: 1px solid #a1a1a1;
    padding: 10px 10px; 
    background: #dddddd;
    
    border-radius: 5px;
}  
.white-popup {
  position: relative;
  background: #FFF;
  padding: 20px;
  width: auto;
  max-width: 80%;
  margin: 20px auto;
}
.ui-btn-width {
    width: 200px !important;
}

  </style>


</head>
<body>


<div align="center" data-role="page" id="JobsOrderDetails"> 
 
	<div   data-role="header" data-position="fixed">
		
		<table width = "100%">
			<TR height="70px">
				<TD width = "20%" Valign="bottom" align="left">
				<a href = "javascript:gotoOrders()"      class="ui-btn ui-btn-width ui-btn-inline ui-icon-back ui-corner-all ui-shadow ui-btn-icon-left">
				Orders</a></td>
				<TD width = "10%" Valign="bottom" align="center"></TD>
				<TD width = "40%" valign="Top" align= "center"><h1 style="font-size: 150%">
				<B><a onclick="window.location.href='JobsHome.htm'" style="color:black; text-decoration:none;">MyJobs - Details</a></B></H1>
				<a href="#lastSyncDets" data-rel="popup"style="color: green; text-decoration:none;"> <Small><P id="lastsync"></p></A></small></TD>
				<TD width = "15%" Valign="bottom" align="right" >
				<a id = "CreateTConf" href='#popupCreateTConf'  class="open-popup-link ui-btn-width ui-btn ui-btn-inline ui-icon-plus ui-corner-all ui-shadow ui-btn-icon-left">
				Create Confirmation</a>
				<TD width = "15%" Valign="bottom" align="right" >
				<a id="ButtonGas"    hidden   href = "javascript:gotoGAS()"           class="ui-btn-width ui-btn ui-btn-inline ui-icon-forward ui-corner-all ui-shadow ui-btn-icon-left ">GAS</a>
				</td>
				
			</TR>
		</table>		
	
	</div> 	

	<div  id="OrderDetails" data-role="content">	

		
				<div  style="background:#e9e9e9 " class="boxeddiv">
				<table width = "100%">
						<TR height="70px">
							<TD width = "80%" Valign="middle" align="left"><h3 align="left">Order Details: <B id="OrderNo"></B></h3></td>
							<TD width = "70%" Valign="middle" align="right" >
								<a id="ButtonShowMap"  href = "javascript:showOnMap()"   class="ui-btn ui-btn-inline ui-icon-home ui-corner-all ui-shadow " style="color:green;" ><img src="images/gis.gif"  height="30" width="30"></a>
							</td>
							
						</TR>
					</table>	
					
					<div class="boxeddiv1" style="background:white " width = "100%"> 
					<table width = "95%">
						<TR>
							<TD width ="15%">Job Description:&nbsp;<td width = "45%"><b id="OrderDesc"></b></td>
							<TD width ="10%">Job Detail:&nbsp;<td width = "30%"><b id="OperationDesc"></b></td>
						</TR>
						<TR>
							<TD width ="15%">Original Location:&nbsp;<td width = "45%"><b id="OrderAddress"></b></td>
							<TD width ="10%">Job Type:&nbsp;<td width = "30%"><b id="OrderType"></b></td>
						</TR>
						<TR>
							<TD width ="15%">Notification No:&nbsp;&nbsp;<a href="javascript:gotoNotification()" ><i class="fa fa-lg fa-binoculars  pull-right fa-border"></i></a></TD>
							<td width = "45%"><b id="NotifNo"></b>
							
							</td>
							<TD width ="10%">Job Priority:&nbsp;<td width = "30%"><b id="OperationPriority"></b></td>
						</TR>


					</table><BR>
					</div>
				
				</div>
				
				<div  style="background:#e9e9e9 "class="boxeddiv">	
					<table width = "100%">
						<TR height="70px">
							<TD width = "30%" Valign="middle" align="left"><h3 align="left">Operation Details: <B id="OpNo"></B></h3></td>
							<TD width = "70%" Valign="middle" align="center" colspan = "2">
								<a id="ButtonAccepted" hidden href = "javascript:AcceptedPressed()"   class="ui-btn ui-btn-inline ui-icon-home ui-corner-all ui-shadow " style="color:green;" >Accept</a>
								<a id="ButtonCancel"  hidden  href = "javascript:RejectPressed()"     class="ui-btn ui-btn-inline ui-icon-home ui-corner-all ui-shadow " style="color:Red;" >Reject</a>
								<a id="ButtonOnRoute" hidden  href = "javascript:OnRoutePressed()"    class="ui-btn ui-btn-inline ui-icon-home ui-corner-all ui-shadow ui-disabled">On-Route</a>
								<a id="ButtonOnSite"  hidden  href = "javascript:OnSitePressed()"     class="ui-btn ui-btn-inline ui-icon-home ui-corner-all ui-shadow ui-disabled">On-Site</a>
								<a id="ButtonSuspended" hidden href = "javascript:SuspendedPressed()"  class="ui-btn ui-btn-inline ui-icon-home ui-corner-all ui-shadow ui-disabled">Suspended</a>
								<a id="ButtonFinished" hidden href = "javascript:FinishedPressed()"   class="ui-btn ui-btn-inline ui-icon-home ui-corner-all ui-shadow ui-disabled">Finished</a>
								
							</td>
							
						</TR>
					</table>				
						
					<div class="boxeddiv1" style="background:white " width = "100%"> 
						<table width = "95%">
							<TR>
								<TD width ="15%">Start Date:<td  width = "45%"><b id="OperationStartdate"></B></td>
								<TD width ="10%">Appt Start:<td  width = "30%"><B id="OperationApptStartdate"></B></td>
							</TR>
							<TR>
								<TD width ="15%">End Date:<td  width = "45%"><b id="OperationEnddate"></b></td>
								<TD width ="10%">Appt End:<td  width = "30%"><b id="OperationApptEnddate"></b></td>
							</TR>
							<TR>
								<TD width ="15%">Type:<td  width = "45%"><b id="OperationType"></b></td>
								<TD width ="10%">Duration:<td  width = "30%"><b id="OperationDuration"></b></td>
							</TR>
						</table><BR>
					</div>
				</div>
				
				
			<div  class="boxeddiv" align="left" data-role="inlinetabs"  data-theme="a" data-scroll="true" >
			<ul >
				
				<li data-tab="1" onclick="tabsClicked('Objects')">&nbsp;<img src="images/Orders/objects.gif"  height="42" width="42">Objects</li>
				<li data-tab="2" onclick="tabsClicked('Materials')">&nbsp;<img src="images/Orders/material.gif"  height="42" width="42">Materials</li>
				<li data-tab="3" onclick="tabsClicked('Partners')">&nbsp;<img src="images/Orders/partners.gif"  height="42" width="42"> Partners</li>
				<li data-tab="4" onclick="tabsClicked('TimeConfs')">&nbsp;<img src="images/Orders/timeconf.gif"  height="42" width="42"> Confirmations</li>
			</ul>
						
				
				<div data-tab="1"    >
					
					<table width="100%" id="ObjectsList">
						
					</table>
				</div>					
				<div data-tab="2"   >
					
					<table width="100%" id="MaterialsList">

					</table>
				  </div>
					<div data-tab="3"   >
					
					<table width="100%" id="PartnersList">

					</table>
				  </div>
					<div data-tab="4"   >

					<table width="100%" id="TimeConfsList">

					</table>
				  </div>				  
									
				</div>
<div style='display:none'>	
<div data-role="popup" id="lastSyncDets">
  <p id='referenceSyncDetails' ></p>
  <p id='transactionalSyncDetails' ></p>
  <p id='uploadSyncDetails' ></p>
</div>			


<div data-role="popup" id="popupMaterial"  data-dismissible="false" style="width:300px" >
    <div data-role="header" data-theme="a"><h1>Material Consumed</h1></div>
    <div role="main"  class="ui-content">
        <Table width="100%">
		    <TR><TD colspan="2"><label for="Material">Material:</label></TD></TR>
            <TR><TD colspan="2"><input type="text" name="Material" id="Material" readonly></TD></TR>
            <TR><TD colspan="2"><label for="Description">Description:</label></TD></TR>
            <TR><TD colspan="2"><input type="text" name="Description" id="Description" readonly></TD></TR>
            <TR><TD colspan="2"><label for="Quantity">Available:</label></TD></TR>
            <TR><TD colspan="2"><input type="text" name="Quantity" id="Quantity" readonly></TD></TR>
            <TR><TD colspan="2"><label for="Used">Used:</label></TD></TR>
            <TR><TD colspan="2"><input type="text" name="Used" id="Used"></TD></TR>             
            <TR><TD align="left"><a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline" data-rel="back">Cancel</a></TD>
            <TD align="right"> <a href="#"  class="ui-btn ui-corner-all ui-shadow ui-btn-inline" data-rel="back" >Save</a></TD></TR> 
        </Table>
    </div><!--End Content-->
                 

</div>		
			
		
			<div id="popupCreateTConf"  class="white-popup mfp-hide"  style="width:80%" >
				
				<div data-role="header" data-theme="a"><CENTER><B><h3>Create Time Confirmation</h3></B></CENTER></div>
				<div role="main"  class="ui-content" >
					<Table  width="95%">
						<TR><TD width="25%" ><label for="PersonelID">Personel ID:</label></TD>
							<TD colspan="3">				  
								<select style="text-align:right;" name="PersonelID" id="PersonelID" width="40px">

							   </select>
							</TD></TR>
						<TR><TD><label for="ConfType">Type:</label></TD>
							<TD colspan="3">				  
								<select name="ConfType" id="ConfType" >
								  <option value="Work">Work</option>
								  <option value="Travel">Travel</option>
							   </select>
							</TD></TR>
						<TR><TD>Start Date:</TD><TD width="35%"><input id="StartDate" type="date" data-format="dd-mm-yy" ></TD>
							<TD align="right" width="10%">Time:</TD><TD><input id="StartTime" type="time" ></TD></TR>
						<TR><TD>End Date:</TD><TD><input id="EndDate"  type="date"></TD>
							<TD align="right" >Time:</TD><TD> <input id="EndTime" type="time"></TD></TR>
						 <TR><TD><label for="ActWork">Duration:</label></TD>
							<TD ><input type="number" name="ActWork" id="ActWork" ></TD>
						
						<TD align="right" ><label for="FinalConf">Final:</label></TD>
							<TD><input type="checkbox" data-on-text="Yes" data-off-text="No"  data-role="flipswitch" name="FinalConf" id="FinalConf"></TD></TR> 
						<TR><TD><label for="Comments">Comments:</label></TD>
							<TD colspan="3"><input type="text" name="Comments" id="Comments"></TD></TR>
					</Table>
				
				
					
								
					<div width="95%">
					<TABLE width="100%">
						<TR><TD align="left"><a href="javascript:PopupClose('CANCEL')" style="color: black;background: lightgrey" class="ui-btn ui-corner-all ui-shadow ui-btn-inline" ><i class="fa fa-times"></i> Cancel</a></TD>
							<TD align="right"><a href="javascript:PopupClose('SAVE')" style="color: black;background: lightgrey"  class="ui-btn ui-corner-all ui-shadow ui-btn-inline" ><i class="fa fa-floppy-o"></i> Save</a></TD></TR> 
					</Table>    
					</div>
				</div>
			</div>	
		</div>






	

		</div>


	
		



 
</div> 
</body>
<script>

html5sql.openDatabase("com.PJO.MyJobs","MyJobs", 5*1024*1024);	

var GASJob=false

$('#ButtonGas').hide();
    jQuery.extend(jQuery.mobile,
    {
      ajaxEnabled: false
    });
var CurrentOrderNo="";
var CurrentOpNo="";
var FinalConfirmed=false;
var PostCode=""
function tabsClicked(tab){

if(tab=='TimeConfs'){
	if(FinalConfirmed){
		$('#CreateTConf').hide();
		}else{
		$('#CreateTConf').show();
		}
}else{
$('#CreateTConf').hide();
}


}
//var db = openDatabase('MyJobsDB', '1.0', 'MyJobsDB', 2000000);	
var JobNo = getURLParameters("JobNo");
var Status = getURLParameters("Status");
var NotifNo = getURLParameters("NotifNo");
var LatLongType=getURLParameters("LatLongType");
var LatLong=getURLParameters("LatLong");
var res = JobNo.split("-")
var OrderNo = res[0];

var EmployeeID=localStorage.getItem("EmployeeID")
var CurrentEmployee="";
function gotoOrders()
{
loc="JobsOrders.htm"
window.location.href=loc;
} 
function gotoNotification()
{
loc="JobsNotificationDetails.htm?JobNo="+JobNo+"&Status="+Status+"&NotifNo="+NotifNo+"&Callback=Order"
window.location.href=loc;
} 
function gotoTasks()
{
loc="JobsOrdersDetailsTasks.htm?JobNo="+JobNo+"&Status="+Status+"&NotifNo="+NotifNo //CurrentNotifType
window.location.href=loc;
} 

function gotoGAS()
{
loc="JobsOrdersDetailsGas.htm?JobNo="+JobNo+"&Status="+Status+"&NotifNo="+NotifNo //CurrentNotifType
window.location.href=loc;
} 

$('#CreateTConf').hide();  
  
 function showOnMap(){
window.location.href='JobsShowMap.htm?&CallBack=Order&JobNo='+JobNo+'&Status='+Status+'&NotifNo='+NotifNo+'&PostCode='+PostCode

} 
function AcceptedPressed(){

	updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JACC", "Job Accepted")
	$('#ButtonAccepted').addClass('ui-disabled');
	$('#ButtonOnRoute').removeClass('ui-disabled');
	$('#ButtonOnSite').removeClass('ui-disabled');
	$('#ButtonSuspended').removeClass('ui-disabled');
	$('#ButtonFinished').removeClass('ui-disabled');
	$('#ButtonCancel').hide();
	$('#ButtonAccepted').show();
	$('#ButtonOnRoute').show();
	$('#ButtonSuspended').show();
	$('#ButtonFinished').show();
	$('#ButtonOnSite').show();
	if (GASJob){
		$('#ButtonGas').show();
		}

}
function OnRoutePressed(){
	sendSMS('011447540293818','Engineer on Route')
updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JONR", "On-Route")
	$('#ButtonAccepted').addClass('ui-disabled');
	$('#ButtonOnRoute').addClass('ui-disabled');
	$('#ButtonOnSite').removeClass('ui-disabled');
	$('#ButtonSuspended').removeClass('ui-disabled');
	$('#ButtonFinished').removeClass('ui-disabled');
	$('#ButtonCancel').hide();
	$('#ButtonAccepted').show();
	$('#ButtonOnRoute').show();
	$('#ButtonSuspended').show();
	$('#ButtonFinished').show();
	$('#ButtonOnSite').show();
	if (GASJob){
		$('#ButtonGas').show();
		}
}
function RejectPressed(){
updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JREJ" ,"Job Rejected")
	// Need to update Rejected Status"
	window.location.href='JobsOrders.htm'
}
function OnSitePressed(){
updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JSTR", "Job Started")
	$('#ButtonAccepted').addClass('ui-disabled');
	$('#ButtonOnSite').addClass('ui-disabled');
	$('#ButtonOnRoute').removeClass('ui-disabled');
	$('#ButtonSuspended').removeClass('ui-disabled');
	$('#ButtonFinished').removeClass('ui-disabled');
	$('#ButtonCancel').hide();
	$('#ButtonAccepted').show();
	$('#ButtonOnRoute').show();
	$('#ButtonSuspended').show();
	$('#ButtonFinished').show();
	$('#ButtonOnSite').show();	
	if (GASJob){
		$('#ButtonGas').show();
		}

}
function SuspendedPressed(){

updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JSUS", "Job Suspended")

	$('#ButtonOnRoute').removeClass('ui-disabled');
	$('#ButtonOnSite').removeClass('ui-disabled');
	$('#ButtonSuspended').addClass('ui-disabled');
	$('#ButtonFinished').removeClass('ui-disabled');		
	$('#ButtonCancel').hide();
	$('#ButtonAccepted').show();
	$('#ButtonOnRoute').show();
	$('#ButtonSuspended').show();
	$('#ButtonFinished').show();
	$('#ButtonOnSite').show();
	if (GASJob){
		$('#ButtonGas').show();
		}
}
function FinishedPressed(){

updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JFIN", "Job Finished")

	$('#ButtonOnRoute').addClass('ui-disabled');
	$('#ButtonOnSite').addClass('ui-disabled');
	$('#ButtonSuspended').addClass('ui-disabled');
	$('#ButtonFinished').addClass('ui-disabled');
	$('#ButtonCancel').hide();
	$('#ButtonAccepted').show();
	$('#ButtonOnRoute').show();
	$('#ButtonSuspended').show();
	$('#ButtonFinished').show();
	$('#ButtonOnSite').show();
	if (GASJob){
		$('#ButtonGas').show();
		}
}
$(document).ready(function() {

	
GetOrderDetails(); 
BuildObjectList()
BuildMaterialList()
BuildPartnerList()
BuildTimeConfList("")
BuildEmployeeList()

})

function BuildObjectList(){
var Stripe="";
var opMap="";
var opGas="";
var opAppt=""
var HTMLToOutput='';

var EmployeeID=localStorage.getItem("EmployeeID")


SQLStatement="SELECT * From MyAssets where orderno = '"+CurrentOrderNo+"'";
HTMLToOutput+= '<THEAD><TR>'
HTMLToOutput+= '							<TH align="left" width="5%">Type</TH>'
HTMLToOutput+= '							<TH align="left" width="25%">No</TH>'
HTMLToOutput+= '							<TH align="left" width="70%">Description</TH>'


HTMLToOutput+= '							</TR>'
HTMLToOutput+= '						<tbody >'

	html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];
					if (isEven(n)){
						Stripe='stripe';
						}
					HTMLToOutput+="	<tr class='"+Stripe+"'>";
					HTMLToOutput+= '			<td>'+item.type+'</td>';
					HTMLToOutput+= '			<td>'+item.id+'</td>';
					HTMLToOutput+= '			<td>'+item.name+'</td>';
					HTMLToOutput+= '	</tr>';	
					}
				HTMLToOutput+= '</tbody >'	
				$( "#ObjectsList").html(HTMLToOutput);
			$	( "#ObjectsList").trigger('create');


		
	 },
	 function(error, statement){
		alert(error.message +statement)
	 }        
	);



}
function BuildMaterialList(){
var Stripe="";
var opMap="";
var opGas="";
var opAppt=""
var HTMLToOutput='';

var EmployeeID=localStorage.getItem("EmployeeID")


SQLStatement="SELECT  * From MyMaterials where orderno = '"+CurrentOrderNo+"'";
HTMLToOutput+= '<THEAD>						<TR>'
HTMLToOutput+= '							<TH align="left" width="20%">No</TH>'
HTMLToOutput+= '							<TH align="left" width="50%">Description</TH>'
HTMLToOutput+= '							<TH align="left" width="15%">Qty</TH>'
HTMLToOutput+= '							<TH align="left" width="15%">Used</TH>'
HTMLToOutput+= '							</TR>'
HTMLToOutput+= '						<tbody>'

	html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];
					if (isEven(n)){
						Stripe='stripe';
						}
					HTMLToOutput+="	<tr class='"+Stripe+"'>";
					HTMLToOutput+= '			<td>'+item.material+'</td>';
					HTMLToOutput+= '			<td>'+item.description+'</td>';
					HTMLToOutput+= '			<td colspan="2">'+item.qty+'</td>';
					HTMLToOutput+= '	</tr>';	
					}
				HTMLToOutput+= '</tbody >'	
				$( "#MaterialsList").html(HTMLToOutput);
			//$	( "#MaterialsList").trigger('create');


		
	 },
	 function(error, statement){
		alert(error.message +statement)
	 }        
	);



}
function BuildPartnerList(){
var Stripe="";
var opMap="";
var opGas="";
var opAppt=""
var HTMLToOutput='';

var EmployeeID=localStorage.getItem("EmployeeID")


SQLStatement="SELECT  * From MyPartners where orderno = '"+CurrentOrderNo+"'";
HTMLToOutput+="				<THEAD>		<TR>"
HTMLToOutput+="							<TH align=\"left\" width=\"25%\">Id</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"5%\">Type</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"15%\">Name</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"15%\">TelNo</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"40%\">Address</TH>"
HTMLToOutput+="							</TR>"
HTMLToOutput+="						<tbody >"


	html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];
					if (isEven(n)){
						Stripe='stripe';
						}
					HTMLToOutput+="	<tr class='"+Stripe+"'>";
					HTMLToOutput+= '			<td width="25%">'+item.id+'</td>';
					HTMLToOutput+= '			<td width="5%">'+item.type+'</td>';
					HTMLToOutput+= '			<td width="15%">'+item.name+'</td>';
					HTMLToOutput+= '			<td width="15%">'+item.telno+'</td>';
					HTMLToOutput+= '			<td width="40%">'+item.address+'</td>';
					HTMLToOutput+= '	</tr>';	
					}
				HTMLToOutput+= '</tbody >'	
				$( "#PartnersList").html(HTMLToOutput);
			//$	( "#PartnersList").trigger('create');


		
	 },
	 function(error, statement){
		alert(error.message +statement)
	 }        
	);



}
function BuildTimeConfList(type){
var Stripe="";
var Delete="";
var HTMLToOutput='';

var EmployeeID=localStorage.getItem("EmployeeID")
FinalConfirmed=false

SQLStatement="SELECT  * From MyTimeConfs where orderno = '"+CurrentOrderNo+"' and opno ='"+CurrentOpNo+"'";
HTMLToOutput+="				<THEAD>		<TR>"
HTMLToOutput+="							<TH align=\"left\" width=\"10%\">Id</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"15%\">Start</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"15%\">End</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"7%\">Time</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"5%\">Type</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"38%\">Comment</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"5%\">Final</TH>"
HTMLToOutput+="							<TH align=\"left\" width=\"5%\">Del</TH>"
HTMLToOutput+="							</TR>"
HTMLToOutput+="						<tbody >"


	html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];
					if (isEven(n)){
						Stripe='stripe';
						}
					Delete="&nbsp;"
					if(item.final=="Yes"){
						FinalConfirmed=true
						
						}
					if(item.confno=="NEW"){
					
						Delete="<a href='#' onClick='DeleteTConf("+item.id+")' ><img src='images\\delete.gif'  ></A>"
					
					}
					HTMLToOutput+="	<tr class='"+Stripe+"'>";
					HTMLToOutput+= '			<td >'+item.empid+'</td>';
					HTMLToOutput+= '			<td >'+convertDate(item.date+' '+item.time)+'</td>';
					HTMLToOutput+= '			<td >'+convertDate(item.enddate+' '+item.endtime)+'</td>';
					HTMLToOutput+= '			<td >'+item.duration+'</td>';
					HTMLToOutput+= '			<td >'+item.type+'</td>';
					HTMLToOutput+= '			<td >'+item.description+'</td>';
					HTMLToOutput+= '			<td >'+item.final+'</td>';
					HTMLToOutput+= '			<td >'+Delete+'</td>';
					HTMLToOutput+= '	</tr>';	
					}
					if(type == "TConfTab"){
						if(FinalConfirmed){
							$('#CreateTConf').hide();
							}else{
							$('#CreateTConf').show();
							}
					}
				HTMLToOutput+= '</tbody >'	
				$( "#TimeConfsList").html(HTMLToOutput);
			//$	( "#TimeConfsList").trigger('create');


		
	 },
	 function(error, statement){
		alert(error.message +statement)
	 }        
	);



}

function BuildEmployeeList(){
var Stripe="";
var opMap="";
var HTMLToOutput='';

var EmployeeID=localStorage.getItem("EmployeeID")


SQLStatement="SELECT  * From MyRefUsers ";



	html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];

					HTMLToOutput+= '			<option value="'+item.employeeno+'">'+item.employeeno+' - '+item.firstname+' '+item.lastname+'</option>'
					if (item.employeeno == EmployeeID){
						CurrentEmployee = item.employeeno+' - '+item.firstname+' '+item.lastname
						}
					}
	
				$( "#PersonelID").html(HTMLToOutput);
			//$	( "#PersonelID").trigger('change');


		
	 },
	 function(error, statement){
		alert(error.message +statement)
	 }        
	);



}

$('.open-popup-link').magnificPopup({
  type:'inline',
  closeOnBgClick: false,
  showCloseBtn:false,
  midClick: true, // Allow opening popup on middle mouse click. Always set it to true if you don't provide alternative source in href.
  callbacks: {
    open: function() {
	
	$('#PersonelID').val(EmployeeID);
	$('#ConfType').val("Work");
	$('#StartDate').val("")
	$('#StartTime').val("")
	$('#EndDate').val("")
	$('#EndTime').val("")
	$('#ActWork').val("")
	$('#Comments').val("")

	$('#FinalConf')[0].checked=false
	$("#ConfType").trigger('change')
	$("#FinalConf").trigger('change')
	$("#PersonelID").trigger('change');
//$("[data-role='footer']").hide();
    },
    close: function() {
		




    }
	}
});
function DeleteTConf(id)
{
	html5sql.process("DELETE from MyTimeConfs where id = '"+id+"'",
	 function(transaction, results, rowsArray){
	 
			 BuildTimeConfList("TConfTab")
			 
	 },
	 function(error, statement){
		
	 }        
	);


}
function PopupClose(mode)
{


	PopupCloseType=mode;
	if(mode=="SAVE"){

		StartDate=$('#StartDate').val().substring(0,4)+$('#StartDate').val().substring(5,7)+$('#StartDate').val().substring(8,10);
		StartTime=$('#StartTime').val().substring(0,2)+$('#StartTime').val().substring(3,5)
		EndDate=$('#EndDate').val().substring(0,4)+$('#EndDate').val().substring(5,7)+$('#EndDate').val().substring(8,10);
		EndTime=$('#EndTime').val().substring(0,2)+$('#EndTime').val().substring(3,5)
		
		if($('#FinalConf')[0].checked==true){
			FinalConf="Yes"
			}
			else
			{
			FinalConf="No"
			}
			
		

		html5sql.process("INSERT INTO  MyTimeConfs (orderno , opno,type, confno , description , date , time , enddate, endtime, duration, empid, final , datestamp, user, state) VALUES ("+
							 "'"+CurrentOrderNo+"','"+CurrentOpNo+"','"+$('#ConfType').val()+"','NEW','"+$('#Comments').val()+"','"+StartDate+"','"+StartTime+"','"+EndDate+"','"+EndTime+"','"+$('#ActWork').val()+"','"+$('#PersonelID').val()+"','"+FinalConf+"','"+getDate()+" "+getTime()+"','"+localStorage.getItem("MobileUser")+"','');",
			 function(){
				 BuildTimeConfList("TConfTab")
			 },
			 function(error, statement){
				opMessage("Error: " + error.message + " when createTConf processing " + statement);
			 }        
			)
		}


	$.magnificPopup.close();
}
function GetOrderDetails(){

var Stripe="";
var opMap="";
var opAppt=""
var HTMLToOutput='';
var n=1;

res = JobNo.split("-")
CurrentOrderNo=res[0];
CurrentOpNo=res[1];
TaskNo="000"+CurrentOpNo/10;


	SQLStatement="SELECT MyOperations.orderno,MyOrders.notifno, MyOperations.opno,MyOperations.startdate, MyOperations.type as optype,MyOperations.duration as opduration,MyOperations.enddate, MyOrders.address, MyOrders.workaddress, MyOrders.type, MyOperations.status, MyOrders.priority, MyOrders.house,MyOrders.houseno,MyOrders.street,MyOrders.district,MyOrders.city,MyOrders.postcode,"
	SQLStatement+=" MyOperations.apptstart, MyOperations.apptend, MyOrders.shorttext as orderdesc , MyOperations.shorttext as operationdesc , MyOrders.contact , MyOrders.property, MyOrders.propertygis, MyOrders.funcloc, MyOrders.funclocgis,  MyOrders.equipment, MyOrders.equipmentgis "
	SQLStatement+=" From MyOperations "
	SQLStatement+=" join MyOrders on MyOperations.orderno=MyOrders.orderno "
	SQLStatement+=" where MyOperations.orderno = '"+CurrentOrderNo+"' and MyOperations.opno = '"+CurrentOpNo+"'"

	SQLStatement1="SELECT * From MyOperationInfo "
	SQLStatement1+=" where MyOperationInfo.orderno = '"+CurrentOrderNo+"' and MyOperationInfo.opno = '"+CurrentOpNo+"' "
	html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){
				


			item = rowsArray[0];
				
			if(item.type=="PM02"){
				//alert("its GAS")
				GASJob=true
			}
			$( "#OrderNo").html(item.orderno);
			$( "#OpNo").html(item.opno);
			$( "#OrderDesc").html(item.orderdesc);
			$( "#OperationDesc").html(item.operationdesc);
			$( "#NotifNo").html(item.notifno);					
			$( "#OrderAddress").html(item.address);
			$( "#OrderType").html(item.type);
			$( "#OrderWorkAddress").html(item.workaddress);
			$( "#OperationPriority").html(item.priority);
			$( "#OperationStartdate").html(convertDate(item.startdate));
			$( "#OperationEnddate").html(convertDate(item.enddate));
		    //$( "#OperationApptStartdate").html(item.apptstart);
			//$( "#OperationApptEnddate").html(item.apptend);
			$( "#OperationType").html(item.optype);
			$( "#OperationDuration").html(item.opduration);
			$( "#OrderProperty").html(item.property);
			$( "#EditProperty").val(item.property);

			$( "#OrderPropertyGIS").html(item.propertygis);
			$( "#OrderFuncLoc").html(item.funcloc);
			$( "#EditFuncLoc").val(item.funcloc);
			$( "#OrderFuncLocGIS").html(item.funclocgis);
			$( "#OrderEquipment").html(item.equipment);
			$( "#EditEquipment").val(item.equipment);
			$( "#OrderEquipmentGIS").html(item.equipmentgis);
			
			
			$( "#HouseName").val(item.house);
			$( "#HouseNo").val(item.houseno);
			$( "#Street").val(item.street);
			$( "#District").val(item.district);
			$( "#City").val(item.city);
			$( "#Postcode").val(item.postcode);
			PostCode=item.postcode;
			$( "#EditPropertyGIS").val(item.propertygis);
			$( "#EditFuncLocGIS").val(item.funclocgis);
			$( "#EditEquipmentGIS").val(item.equipmentgis);

			
			$( "#OrderDetails").trigger('create');		
		
			html5sql.process(SQLStatement1,
			 function(transaction, results, rowsArray){
					if(rowsArray.length>0){
						item = rowsArray[0];
						
						if(item.type=="APPT"){
							$( "#OperationApptStartdate").html(item.value1.substring(0,4)+"-"+item.value1.substring(4,2)+"-"+item.value1.substring(6,8));
							$( "#OperationApptEnddate").html(item.value2.substring(0,2)+":"+item.value2.substring(2,4));
						}
					}
				if(Status=="Dispatched"){
					$('#ButtonAccepted').removeClass('ui-disabled');
					$('#ButtonCancel').removeClass('ui-disabled');
					$('#ButtonAccepted').show();
					$('#ButtonCancel').show();



				}
				if(Status=="Accepted"){
					$('#ButtonAccepted').addClass('ui-disabled');
					$('#ButtonOnRoute').removeClass('ui-disabled');
					$('#ButtonOnSite').removeClass('ui-disabled');
					$('#ButtonSuspended').removeClass('ui-disabled');
					$('#ButtonFinished').removeClass('ui-disabled');
					$('#ButtonGas').removeClass('ui-disabled');
					$('#ButtonAccepted').show();
					$('#ButtonOnRoute').show();
					$('#ButtonOnSite').show();
					$('#ButtonSuspended').show();
					$('#ButtonFinished').show()
					
					if (GASJob){
						$('#ButtonGas').show();
						}
					


				} 
				if(Status=="OnRoute"){
					$('#ButtonAccepted').addClass('ui-disabled');
					$('#ButtonOnRoute').addClass('ui-disabled');
					$('#ButtonOnSite').removeClass('ui-disabled');
					$('#ButtonSuspended').removeClass('ui-disabled');
					$('#ButtonFinished').removeClass('ui-disabled');
					$('#ButtonGas').removeClass('ui-disabled');
					$('#ButtonAccepted').show();
					$('#ButtonOnRoute').show();
					$('#ButtonOnSite').show();
					$('#ButtonSuspended').show();
					$('#ButtonFinished').show()
					
					if (GASJob){
						$('#ButtonGas').show();
						}
					


				} 
				if(Status=="OnSite"){
					$('#ButtonAccepted').addClass('ui-disabled');
					$('#ButtonOnRoute').removeClass('ui-disabled');
					$('#ButtonOnSite').addClass('ui-disabled');
					$('#ButtonSuspended').removeClass('ui-disabled');
					$('#ButtonFinished').removeClass('ui-disabled');
					$('#ButtonGas').removeClass('ui-disabled');
					$('#ButtonAccepted').show();
					$('#ButtonOnRoute').show();
					$('#ButtonOnSite').show();
					$('#ButtonSuspended').show();
					$('#ButtonFinished').show()
					
					if (GASJob){
						$('#ButtonGas').show();
						}
					

				} 
				if(Status=="Suspended"){
					$('#ButtonAccepted').addClass('ui-disabled');
					$('#ButtonOnRoute').removeClass('ui-disabled');
					$('#ButtonOnSite').removeClass('ui-disabled');
					$('#ButtonSuspended').addClass('ui-disabled');
					$('#ButtonFinished').removeClass('ui-disabled');
					$('#ButtonGas').removeClass('ui-disabled');

					$('#ButtonAccepted').show();
					$('#ButtonOnRoute').show();
					$('#ButtonOnSite').show();
					$('#ButtonSuspended').show();
					$('#ButtonFinished').show()
					if (GASJob){
						$('#ButtonGas').show();
						}



				} 
				if(Status=="Finished"){
					$('#ButtonAccepted').addClass('ui-disabled');
					$('#ButtonOnRoute').addClass('ui-disabled');
					$('#ButtonOnSite').addClass('ui-disabled');
					$('#ButtonSuspended').addClass('ui-disabled');
					$('#ButtonFinished').addClass('ui-disabled');
					$('#ButtonGas').removeClass('ui-disabled');
					
					$('#ButtonAccepted').show();
					$('#ButtonOnRoute').show();
					$('#ButtonOnSite').show();
					$('#ButtonSuspended').show();
					$('#ButtonFinished').show()

					if (GASJob){
						
						$('#ButtonGas').show();
						}
					


				}
			 },
			 function(error, statement){
				
			 }        
			);

		


	 },
	 function(error, statement){
		
	 }        
	);


	


	


	
}
function saveEquipment(){
	updateOrderEquipment(OrderNo,$( "#EditProperty").val(),$( "#EditFuncLoc").val(),$( "#EditEquipment").val());
			$( "#EditProperty").val($( "#EditProperty").val());
			$( "#EditFuncLoc").val($( "#EditFuncLoc").val());
			$( "#EditEquipment").val($( "#EditEquipment").val());
			$( "#OrderProperty").html($( "#EditProperty").val());
			$( "#OrderFuncLoc").html($( "#EditFuncLoc").val());
			$( "#OrderEquipment").html($( "#EditEquipment").val());
			$( "#OrderDetails").trigger('create');
}
function saveAddress(){
var workaddress=$( "#HouseName").val()+", "+$( "#HouseNo").val()+", "+$( "#Street").val()+", "+$( "#District").val()+", "+$( "#City").val()+", "+$( "#Postcode").val()
	updateOrderAddress(OrderNo,$( "#HouseName").val(),$( "#HouseNo").val(),$( "#Street").val(),$( "#District").val(),$( "#City").val(),$( "#Postcode").val(),workaddress);
			$( "#HouseName").val($( "#HouseName").val());
			$( "#HouseNo").val($( "#HouseNo").val());
			$( "#Street").val($( "#Street").val());
			$( "#District").val($( "#District").val());
			$( "#City").val($( "#City").val());
			$( "#Postcode").val($( "#Postcode").val());
			$( "#OrderWorkAddress").html(workaddress);
			$( "#OrderDetails").trigger('create');
}
function showMap(type)
{

window.location.href='JobsLocateOnMap.htm?CallBack=Order&JobNo='+JobNo+'&Status='+Status+'&NotifNo='+NotifNo+'&Type='+type+'&LatLong='+$( type).html()
}

function setMaterial(matno){
var Description="Description "+matno
var Quantity="3"
var Used="4"
			$( "#Material").val(matno);
			$( "#Description").val(Description);
			$( "#Quantity").val(Quantity);
			$( "#Used").val(Used);
			$( "#popupMaterial").trigger('create');
}
var w = null; // initialize variable
function startBGSync()
{
		 syncDT=localStorage.getItem('LastSyncedDT')		 
		 document.getElementById("lastsync").innerHTML = "Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)
		 syncDT=localStorage.getItem('LastSyncReference')
		 document.getElementById("referenceSyncDetails").innerHTML ="Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)+"<BR>"+localStorage.getItem('LastSyncReferenceDetails')+" "
		 syncDT=localStorage.getItem('LastSyncTransactional')
		 document.getElementById("transactionalSyncDetails").innerHTML ="Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)+"<BR>"+localStorage.getItem('LastSyncTransactionalDetails')+"  "
		 syncDT=localStorage.getItem('LastSyncUpload')
		 document.getElementById("uploadSyncDetails").innerHTML ="Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)+"<BR>"+localStorage.getItem('LastSyncUploadDetails')

   // First check whether Web Workers are supported
   if (typeof(Worker)!=="undefined"){
      // Check whether Web Worker has been created. If not, create a new Web Worker based on the Javascript file simple-timer.js
      if (w==null){
         w = new Worker("bgsync.js");
      }
      // Update timer div with output from Web Worker
      w.onmessage = function (event) {      
		 syncReference()
		 syncTransactional()
		 syncUpload()
		 syncDT=localStorage.getItem('LastSyncedDT')		 
		 document.getElementById("lastsync").innerHTML = "Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)
		 syncDT=localStorage.getItem('LastSyncReference')
		 document.getElementById("referenceSyncDetails").innerHTML ="Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)+"<BR>"+localStorage.getItem('LastSyncReferenceDetails')+" "
		 syncDT=localStorage.getItem('LastSyncTransactional')
		 document.getElementById("transactionalSyncDetails").innerHTML ="Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)+"<BR>"+localStorage.getItem('LastSyncTransactionalDetails')+"  "
		 syncDT=localStorage.getItem('LastSyncUpload')
		 document.getElementById("uploadSyncDetails").innerHTML ="Last Synced: "+syncDT.substring(0,4)+"-"+syncDT.substring(4,6)+"-"+syncDT.substring(6,8)+" "+syncDT.substring(8,10)+":"+syncDT.substring(10,12)+"<BR>"+localStorage.getItem('LastSyncUploadDetails')


		 };
   } else {
      // Web workers are not supported by your browser
      document.getElementById("lastsync").innerHTML = "Sorry, your browser does not support Web Workers ...";
   }
}
startBGSync()
</script>



 


</html>

